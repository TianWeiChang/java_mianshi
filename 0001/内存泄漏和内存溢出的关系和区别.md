内存泄漏和内存溢出的关系和区别

上周，一位朋友在面试中被问到`内存泄漏和内存溢出的关系和区别`。非常经典的面试题，其实想要完整的回答出来，没那么简单的。

今天，我们就从多方面来详细的聊聊`内存泄漏和内存溢出`。

## 内存泄漏（memory leak）

1、内存泄漏是指程序中已动态分配的堆内存由于某种原因未释放或无法释放，造成系统内存的浪费，导致程序运行速度减慢甚至系统奔溃等严重后果。

2、一次内训泄漏似乎不会有大的影响，但内存泄漏后堆积的结果就是内存溢出。

3、内存泄漏具有隐蔽性，积累性的特征，比其他内存非法访问错误更难检测。这是因为内存泄漏产生的原因是内存块未被释放，属于遗漏型缺陷而不是过错型缺陷。此外，内存泄漏不会直接产生可观察的错误，而是逐渐积累，降低系统的整体性性能。

4、如何有效的进行内存分配和释放，防止内存泄漏，是软件开发人员的关键问题，比如一个服务器应用软件要长时间服务多个客户端，若存在内存泄漏，则会逐渐堆积，导致一系列严重后果。

## 内存泄漏原因

1、在内存中供用户使用的空间分为三部分：

- 程序存储区
- 静态存储区：静态存储区数据在程序开始就已经分配好了内存，执行过程中，它们所占的存储单元是固定的，在程序结束时就 释放，所以该区数据一般为全局变量。
- 动态存储区：动态存储区数据是在程序的执行过程中根据需要动态分配和动态释放的存储单元。

2、没有释放动态分配的存储空间而造成内存泄漏，是动态存储变量的主要问题。

3、常用内存管理函数如下：malloc，free，calloc，recalloc等，来完成动态存储变量存储空间的分配和释放。

4、常见的内存管理错误如下

- 分配一个内存块并使用其中未经初始化的内容；
- 释放一个内存块，但继续引用其中的内容；
- 子函数分配的内存空间在主函数出现异常中断时，或主函数对子函数返回的信 息使用结束时，没有对分配的内存进行释放；
- 程序实现过程中分配的临时内存在程序结束时，没有释放临时内存；
- 内存错误一般是不可在现的，开发人员不易在程序调式和测试阶段发现，即使花费了很多的时间和精力，也无法消除。

## 内存泄漏产生方式的分类

#### 常发性内存泄漏

发生内存泄漏的代码会被多次执行到，每次被执行时都会导致一块内存泄漏。

#### 偶发性内存泄漏

发生内存泄漏的代码只有在某些特定环境或操作过程下才会发生。常发性和偶发性是相对的。对于特定的环境，偶发性的也许就变成了常发性的。所以测试环境和测试方法对检测内存泄漏至关重要。

#### 一次性内存泄漏

发生内存泄漏的代码只会被执行一次，或者由于算法上的缺陷，导致总会有一块且仅有一块内存发生泄漏。

#### 隐式内存泄漏

程序在运行过程中不停的分配内存，但是直到结束的时候才释放内存。严格的说这里并没有发生内存泄漏，因为最终程序释放了所有申请的内存。

但是对于一个服务器程序，需要运行几天，几周甚至几个月，不及时释放内存也可能导致最终耗尽系统的所有内存。所以，我们称这类内存泄漏为隐式内存泄漏。

从用户使用程序的角度来看，内存泄漏本身不会产生什么危害，作为一般的用户，根本感觉不到内存泄漏的存在。真正有危害的是内存泄漏的堆积，这会最终耗尽系统所有的内存。

从这个角度来说，一次性内存泄漏并没有什么危害，因为它不会堆积，而隐式内存泄漏危害性则非常大，因为较之于常发性和偶发性内存泄漏它更难被检测到。

## 内存溢出

指程序在申请内存时，没有足够的内存供申请者使用，或者说，给了你一块存储int类型数据的存储空间，但是你却存储long类型的数据，就会导致内存不够用，报错`OOM`，即出现内存溢出的错误。

## 内存溢出的原因

#### 内存溢出原因

1.内存中加载的数据量过于庞大，如一次从数据库取出过多数据；
2.集合类中有对对象的引用，使用完后未清空，使得JVM不能回收；
3.代码中存在死循环或循环产生过多重复的对象实体；
4.使用的第三方软件中的BUG；
5.启动参数内存值设定的过小

#### 内存溢出的解决方案

第一步，修改`JVM`启动参数，直接增加内存。(`-Xms`，`-Xmx`参数一定不要忘记加。)

第二步，检查错误日志，查看“`OutOfMemory`”错误前是否有其 它异常或错误。

第三步，对代码进行走查和分析，找出可能发生内存溢出的位置。

### 六、内存泄漏和内存溢出的联系

1、内存泄漏的堆积最终会导致内存溢出

2、内存溢出就是你要的内存空间超过了系统实际分配给你的空间，此时系统相当于没法满足你的需求，就会报内存溢出的错误

3、内存泄漏是指你向系统申请分配内存进行使用(new)，可是使用完了以后却不归还(delete)，结果你申请到的那块内存你自己也不能再访问（也许你把它的地址给弄丢了），而系统也不能再次将它分配给需要的程序。就相当于你租了个带钥匙的柜子，你存完东西之后把柜子锁上之后，把钥匙丢了或者没有将钥匙还回去，那么结果就是这个柜子将无法供给任何人使用，也无法被垃圾回收器回收，因为找不到他的任何信息。

4、内存溢出可以这样理解，一个盘子用尽各种方法只能装4个果子，你装了5个，结果掉倒地上不能吃了。这就是溢出。比方说栈，栈满时再做进栈必定产生空间溢出，叫上溢，栈空时再做退栈也产生空间溢出，称为下溢。就是分配的内存不足以放下数据项序列,称为内存溢出。说白了就是我承受不了那么多，那我就报错。