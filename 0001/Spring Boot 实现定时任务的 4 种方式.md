# Spring Boot 实现定时任务的 4 种方式

在我们日常开发中，定时任务肯定是少不了的。比如：做过银行、支付相关行业的朋友都知道，通常都会涉及到对账，至少我见过的对账基本上全是使用定时任务来做的。

常见定时任务实现有四种：

- **Timer** 
- **ScheduledExecutorService** 
- **Spring Task** 
- **Quartz** 

分布式的比较流行的有`Quartz`、`xxl-job`、`Elastic-Job`、`uncode-schedule`，感兴趣的自己可以去研究一下。

篇幅有限，本文只分享前面四种实现方式，下面大致聊聊分布式定时任务框，感兴趣的可以自行研究。

## Quartz

Java事实上的定时任务标准。但Quartz关注点在于定时任务而非数据，并无一套根据数据处理而定制化的流程。虽然Quartz可以基于数据库实现作业的高可用，但缺少分布式并行调度的功能

#### Quartz原理

![集群部署](https://upload-images.jianshu.io/upload_images/10499553-9f0fda23aa381df2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/607/format/webp)

独立的Quratz节点之间是不需要通信的，不同节点之间是通过数据库表来感知另一个应用，只有使用持久的JobStore才能完成Quartz集群。如果某一个节点失效，那么Job会在其他节点上执行。

#### 如何保证只在一台机器上触发？

- 数据库悲观锁
- 一旦某一节点线程获取了该锁，那么Job就会在这台机器上被执行，其他节点进行锁等待；

#### 缺点

1. 不适合大量的短任务 & 不适合过多节点部署；
2. 解决了高可用的问题，并没有解决任务分片的问题，存在单机处理的极限（即：不能实现水平扩展）。
3. 需要把任务信息持久化到业务数据表，和业务有耦合
4. 调度逻辑和执行逻辑并存于同一个项目中，在机器性能固定的情况下，业务和调度之间不可避免地会相互影响。
5. quartz集群模式下，是通过数据库独占锁来唯一获取任务，任务执行并没有实现完善的负载均衡机制。

## Elastic Job

Elastic Job 是当当网架构师开发，是一个分布式调度解决方案，由两个相互独立的子项目Elastic-Job-Lite和Elastic-Job-Cloud组成；定位为轻量级无中心化解决方案，使用 jar 包的形式提供分布式任务的协调服务。支持分布式调度协调、弹性扩容缩容、失效转移、错过执行作业重触发、并行调度、自诊断和修复等等功能特性。

Elastic-Job-Lite定位为轻量级无中心化解决方案，使用jar包的形式提供分布式任务的协调服务；Elastic-Job-Cloud采用自研Mesos Framework的解决方案，额外提供资源治理、应用分发以及进程隔离等功能；

Elastic-Job-Lite并没有宿主程序，而是基于部署作业框架的程序在到达相应时间点时各自触发调度。它的开发也比较简单，引用Jar包实现一些方法即可，最后编译成Jar包运行。Elastic-Job-Lite的分布式部署全靠ZooKeeper来同步状态和原数据。实现高可用的任务只需将分片总数设置为1，并把开发的Jar包部署于多个服务器上执行，任务将会以1主N从的方式执行。一旦本次执行任务的服务器崩溃，其他执行任务的服务器将会在下次作业启动时选择一个替补执行。如果开启了失效转移，那么功能效果更好，可以保证在本次作业执行时崩溃，备机之一立即启动替补执行。

Elastic-Job-Lite的任务分片也是通过ZooKeeper来实现，Elastic-Job并不直接提供数据处理的功能，框架只会将分片项分配至各个运行中的作业服务器，开发者需要自行处理分片项与真实数据的对应关系。框架也预置了一些分片策略：平均分配算法策略，作业名哈希值奇偶数算法策略，轮转分片策略。同时也提供了自定义分片策略的接口。

另外Elastic-Job-Lite还提供了一个任务监控和管理界面：Elastic-Job-Lite-Console。它和Elastic-Job-Lite是两个完全不关联的应用程序，使用ZooKeeper来交换数据，管理人员可以通过这个界面查看、监控和管理Elastic-Job-Lite的任务，必要的时候还能手动触发任务

#### Elastic Job功能列表

- 分布式调度协调
- 弹性扩容缩容
- 失效转移
- 错过执行作业重触发
- 作业分片一致性，保证同一分片在分布式环境中仅一个执行实例
- 自诊断并修复分布式不稳定造成的问题
- 支持并行调度
- 支持作业生命周期操作
- 丰富的作业类型
- Spring整合以及命名空间提供
- 运维平台

#### Elastic Job优缺点

优点：

- 基于成熟的定时任务作业框架Quartz cron表达式执行定时任务；
- 支持任务分片：可以拆分任务，分别由不同节点执行；
- 官网文档齐全，全中文；
- 弹性扩容缩容：运行中的作业服务器崩溃，或新增N台作业服务器，作业框架将在下次作业执行前重新分片，不影响当前作业执行；
- 任务监控和管理界面；

缺点：

- 依赖Zookeeper；

## XXL-JOB

XXL-Job官网 是大众点评员工`徐雪里`于2015年发布的分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。

#### 设计思想

将调度行为抽象形成“调度中心”公共平台，而平台自身并不承担业务逻辑，“`调度中心`”负责发起调度请求。

将任务抽象成分散的`JobHandler`，交由“执行器”统一管理，“执行器”负责接收调度请求并执行对应的`JobHandler`中业务逻辑。

因此，“调度”和“任务”两部分可以相互解耦，提高系统整体稳定性和扩展性；

![架构图 V2.1.0](https://www.xuxueli.com/doc/static/xxl-job/images/img_Qohm.png) 

#### 系统组成

- **调度模块（调度中心）**：
  负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码。调度系统与任务解耦，提高了系统可用性和稳定性，同时调度系统性能不再受限于任务模块；
  支持可视化、简单且动态的管理调度信息，包括任务新建，更新，删除，GLUE开发和任务报警等，所有上述操作都会实时生效，同时支持监控调度结果以及执行日志，支持执行器Failover。
- **执行模块（执行器）**：
  负责接收调度请求并执行任务逻辑。任务模块专注于任务的执行等操作，开发和维护更加简单和高效；
  接收“调度中心”的执行请求、终止请求和日志请求等。

## uncode-schedule 

基于Zookeeper+Spring task/quartz的分布式任务调度组件，确保所有任务在集群中不重复，不遗漏的执行。支持动态添加和删除任务。 